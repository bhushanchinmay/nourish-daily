<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nourish Daily - Test Suite v1.4.4</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #f0f0f0;
            padding: 20px;
        }

        h1,
        h2 {
            margin-bottom: 16px;
        }

        .test-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-case {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }

        .test-case.pass {
            background: rgba(52, 199, 89, 0.2);
            border-left: 3px solid #34C759;
        }

        .test-case.fail {
            background: rgba(255, 59, 48, 0.2);
            border-left: 3px solid #FF3B30;
        }

        .test-case.pending {
            background: rgba(255, 204, 0, 0.2);
            border-left: 3px solid #FFCC00;
        }

        .summary {
            font-size: 1.5em;
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
        }

        .summary.pass {
            background: rgba(52, 199, 89, 0.3);
        }

        .summary.fail {
            background: rgba(255, 59, 48, 0.3);
        }

        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px 10px 0;
        }

        button:hover {
            background: #0056b3;
        }

        .coverage {
            margin-top: 20px;
        }

        .coverage-bar {
            height: 24px;
            background: #333;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
        }

        .coverage-fill {
            height: 100%;
            background: linear-gradient(90deg, #34C759, #30D158);
            transition: width 0.5s;
        }

        pre {
            background: #333;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin-top: 8px;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <h1>ğŸ§ª Nourish Daily Test Suite</h1>
    <p style="opacity: 0.7; margin-bottom: 20px;">Comprehensive integration tests for v1.4.2</p>

    <button onclick="runAllTests()">â–¶ï¸ Run All Tests</button>
    <button onclick="runUnitTests()">ğŸ”¬ Unit Tests</button>
    <button onclick="runIntegrationTests()">ğŸ”— Integration Tests</button>
    <button onclick="runSecurityTests()">ğŸ”’ Security Tests</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>

    <div id="results"></div>

    <div class="coverage" id="coverage-section" style="display: none;">
        <h2>ğŸ“Š Code Coverage</h2>
        <div id="coverage-details"></div>
    </div>

    <script src="data.js"></script>
    <script src="env.config.js"></script>
    <script src="config.js"></script>
    <script>
        // ========================================
        // TEST FRAMEWORK
        // ========================================
        let tests = { passed: 0, failed: 0, total: 0, results: [] };
        const coverageTracker = new Set();

        function assert(condition, testName, category = 'General') {
            tests.total++;
            if (condition) {
                tests.passed++;
                tests.results.push({ name: testName, status: 'pass', category });
            } else {
                tests.failed++;
                tests.results.push({ name: testName, status: 'fail', category });
            }
        }

        function assertEqual(actual, expected, testName, category = 'General') {
            const passed = JSON.stringify(actual) === JSON.stringify(expected);
            tests.total++;
            if (passed) {
                tests.passed++;
                tests.results.push({ name: testName, status: 'pass', category });
            } else {
                tests.failed++;
                tests.results.push({ name: `${testName} (expected: ${JSON.stringify(expected)}, got: ${JSON.stringify(actual)})`, status: 'fail', category });
            }
        }

        function track(funcName) {
            coverageTracker.add(funcName);
        }

        // ========================================
        // MOCK LOCALSTORAGE
        // ========================================
        const mockStorage = {};
        const originalGetItem = localStorage.getItem.bind(localStorage);
        const originalSetItem = localStorage.setItem.bind(localStorage);

        function mockLocalStorage() {
            localStorage.getItem = (key) => mockStorage[key] || null;
            localStorage.setItem = (key, value) => { mockStorage[key] = value; };
            localStorage.removeItem = (key) => { delete mockStorage[key]; };
            localStorage.clear = () => { Object.keys(mockStorage).forEach(k => delete mockStorage[k]); };
        }

        function restoreLocalStorage() {
            localStorage.getItem = originalGetItem;
            localStorage.setItem = originalSetItem;
        }

        // ========================================
        // UNIT TESTS
        // ========================================
        function runUnitTests() {
            resetTests();
            mockLocalStorage();

            // Test 1: Data.js loaded
            track('MEAL_DATA');
            assert(typeof MEAL_DATA === 'object', 'MEAL_DATA object exists', 'Data Loading');

            // Test 2: MEAL_OPTIONS structure
            track('MEAL_OPTIONS');
            assert(Array.isArray(MEAL_OPTIONS.breakfast), 'MEAL_OPTIONS.breakfast is array', 'Data Loading');
            assert(Array.isArray(MEAL_OPTIONS.lunch), 'MEAL_OPTIONS.lunch is array', 'Data Loading');
            assert(Array.isArray(MEAL_OPTIONS.dinner), 'MEAL_OPTIONS.dinner is array', 'Data Loading');

            // Test 3: SNACKS structure
            track('SNACKS');
            assert(typeof SNACKS === 'object', 'SNACKS object exists', 'Data Loading');
            assert(Array.isArray(SNACKS.morning), 'SNACKS.morning is array', 'Data Loading');

            // Test 4: RECIPES structure
            track('RECIPES');
            assert(Array.isArray(RECIPES), 'RECIPES is array', 'Data Loading');
            assert(RECIPES.length >= 4, 'RECIPES has at least 4 items', 'Data Loading');

            // Test 5: Recipe has required fields
            const recipe = RECIPES[0];
            assert(recipe.id && recipe.title, 'Recipe has id and title', 'Data Validation');

            // Test 6: Meal option has required fields
            const meal = MEAL_OPTIONS.breakfast[0];
            assert(meal.id && meal.title, 'Meal option has id and title', 'Data Validation');

            // Test 7: No duplicate recipe IDs
            track('uniqueRecipeIds');
            const recipeIds = RECIPES.map(r => r.id);
            const uniqueRecipeIds = new Set(recipeIds);
            assertEqual(recipeIds.length, uniqueRecipeIds.size, 'No duplicate recipe IDs', 'Data Validation');

            // Test 8: Time ranges valid
            track('TIME_RANGES');
            assert(TIME_RANGES.morning.start === 0, 'Morning starts at 0', 'Time Settings');
            assert(TIME_RANGES.night.end === 24, 'Night ends at 24', 'Time Settings');

            // Test 9: QUICK_BITES structure
            track('QUICK_BITES');
            assert(typeof QUICK_BITES.hungry === 'object', 'QUICK_BITES.hungry exists', 'Data Loading');
            assert(Array.isArray(QUICK_BITES.hungry.items), 'QUICK_BITES.hungry.items is array', 'Data Loading');

            // Test 10: ENV config loaded
            track('ENV');
            assert(typeof ENV === 'object' || typeof window.ENV === 'undefined', 'ENV config exists or is optional', 'Configuration');

            // Test 11: DAILY_ESSENTIALS
            track('DAILY_ESSENTIALS');
            assert(Array.isArray(DAILY_ESSENTIALS), 'DAILY_ESSENTIALS is array', 'Data Loading');

            // Test 12: Meal data for each day
            track('mealDays');
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                assert(MEAL_DATA[day], `MEAL_DATA has ${day}`, 'Weekly Data');
            });

            // Test 13: Each day has breakfast, lunch, dinner
            days.forEach(day => {
                const dayData = MEAL_DATA[day];
                assert(dayData.breakfast && dayData.lunch && dayData.dinner, `${day} has all meals`, 'Weekly Data');
            });

            restoreLocalStorage();
            renderResults('Unit Tests');
        }

        // ========================================
        // INTEGRATION TESTS
        // ========================================
        function runIntegrationTests() {
            resetTests();
            mockLocalStorage();

            // Test: localStorage getStore/setStore simulation
            track('getStore');
            track('setStore');
            localStorage.setItem('nd_customMeals', JSON.stringify([{ id: 'test1', title: 'Test Meal' }]));
            const stored = JSON.parse(localStorage.getItem('nd_customMeals'));
            assert(Array.isArray(stored), 'Can store and retrieve arrays', 'Storage');
            assertEqual(stored[0].id, 'test1', 'Stored meal has correct ID', 'Storage');

            // Test: Capitalize function (simulated)
            track('capitalizeFirst');
            const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
            assertEqual(capitalize('test'), 'Test', 'capitalizeFirst works', 'Utilities');
            assertEqual(capitalize(''), '', 'capitalizeFirst handles empty', 'Utilities');

            // Test: Import data merge logic
            track('importData');
            const existingMeals = [{ id: 'meal1', title: 'Existing' }];
            const importedMeals = [{ id: 'meal2', title: 'Imported' }, { id: 'meal1', title: 'Duplicate' }];
            const merged = [...existingMeals];
            importedMeals.forEach(m => {
                if (!merged.find(e => e.id === m.id)) merged.push(m);
            });
            assertEqual(merged.length, 2, 'Merge avoids duplicates by ID', 'Import/Export');

            // Test: Title-based deduplication
            track('titleDedup');
            const existingTitles = new Set(['paneer paratha', 'dosa']);
            const newMeal = 'Paneer Paratha';
            const isDuplicate = existingTitles.has(newMeal.toLowerCase().trim());
            assert(isDuplicate, 'Title dedup catches case-insensitive duplicates', 'Import/Export');

            // Test: Meal grouping (diet-friendly dedup)
            track('mealGrouping');
            const meals = [
                { id: 'diet_abc_breakfast', title: 'Diet A', isDietFriendly: true },
                { id: 'diet_abc_lunch', title: 'Diet A', isDietFriendly: true },
                { id: 'diet_abc_dinner', title: 'Diet A', isDietFriendly: true },
                { id: 'normal_xyz', title: 'Normal B', isDietFriendly: false }
            ];
            const groups = new Map();
            meals.forEach(m => {
                const baseId = m.isDietFriendly ? m.id.split('_')[0] + '_' + m.id.split('_')[1] : m.id;
                if (!groups.has(baseId)) groups.set(baseId, m);
            });
            assertEqual(groups.size, 2, 'Diet-friendly grouped correctly (3â†’1)', 'Deduplication');

            // Test: Filter logic
            track('filterLogic');
            const card = { type: 'breakfast', diet: false };
            const filters = ['all', 'breakfast', 'lunch', 'diet'];
            const results = filters.map(f => {
                if (f === 'all') return true;
                if (f === 'diet') return card.diet;
                return card.type === f;
            });
            assertEqual(results, [true, true, false, false], 'Filter logic correct', 'Recipes Tab');

            // Test: Time-based active tab
            track('timeBasedTab');
            const getActiveTab = (hour) => {
                if (hour >= 11 && hour < 15) return 'lunch';
                if (hour >= 15) return 'dinner';
                return 'breakfast';
            };
            assertEqual(getActiveTab(9), 'breakfast', 'Morning = breakfast tab', 'Time Logic');
            assertEqual(getActiveTab(12), 'lunch', 'Noon = lunch tab', 'Time Logic');
            assertEqual(getActiveTab(19), 'dinner', 'Evening = dinner tab', 'Time Logic');

            // Test: Ingredient deduplication
            track('ingredientDedup');
            const ingredients = ['tomato', 'onion', 'tomato', 'garlic'];
            const uniqueIngredients = [...new Set(ingredients)];
            assertEqual(uniqueIngredients.length, 3, 'Ingredients deduplicated', 'Prepare Tab');

            // Test: Sample plan export structure
            track('samplePlanExport');
            const samplePlan = {
                version: '1.4.0',
                data: {
                    customMeals: [],
                    customRecipes: [],
                    mealOptions: MEAL_OPTIONS
                }
            };
            assert(samplePlan.version, 'Sample plan has version', 'Import/Export');
            assert(samplePlan.data.mealOptions, 'Sample plan has meal options', 'Import/Export');

            // Test: Modal hidden class logic
            track('modalHidden');
            const createMockElement = () => {
                const classes = new Set(['hidden']);
                return {
                    classList: {
                        add: (c) => classes.add(c),
                        remove: (c) => classes.delete(c),
                        contains: (c) => classes.has(c)
                    }
                };
            };
            const modal = createMockElement();
            assert(modal.classList.contains('hidden'), 'Modal starts hidden', 'UI Logic');
            modal.classList.remove('hidden');
            assert(!modal.classList.contains('hidden'), 'Modal can be shown', 'UI Logic');

            // Test: Date formatting
            track('dateFormatting');
            const today = new Date();
            const dateString = today.toDateString();
            assert(dateString.length > 0, 'Date formatting works', 'Utilities');

            // Test: Selection storage
            track('selectionStorage');
            const selections = {};
            const dayKey = new Date().toDateString();
            selections[dayKey] = { breakfast: { id: 'bf1', title: 'Test' } };
            assertEqual(selections[dayKey].breakfast.id, 'bf1', 'Selection stored correctly', 'Storage');

            // Test: Custom meal structure
            track('customMealStructure');
            const customMeal = {
                id: 'custom_123',
                title: 'My Meal',
                desc: 'Description',
                type: 'breakfast',
                ingredients: ['item1', 'item2'],
                isDietFriendly: false
            };
            assert(customMeal.id && customMeal.title && customMeal.type, 'Custom meal has required fields', 'Data Validation');

            // Test: Imported meal structure
            track('importedMealStructure');
            const importedMeal = {
                id: `imported_lunch_${Date.now()}_abc`,
                title: 'Imported Meal',
                type: 'lunch',
                isImported: true
            };
            assert(importedMeal.isImported === true, 'Imported meal flagged correctly', 'Import/Export');

            restoreLocalStorage();
            renderResults('Integration Tests');
        }

        // ========================================
        // SECURITY TESTS
        // ========================================
        function runSecurityTests() {
            resetTests();

            // Sanitize function
            track('sanitize');
            const sanitize = (str) => {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            assert(typeof sanitize === 'function', 'sanitize function exists', 'Security');

            // Sanitize normal text
            track('sanitizeNormal');
            assertEqual(sanitize('Hello'), 'Hello', 'Sanitize preserves normal text', 'Security');

            // Sanitize escapes script tags
            track('sanitizeXSS');
            const xss = String.fromCharCode(60) + 'script' + String.fromCharCode(62) + 'alert(1)' + String.fromCharCode(60) + '/script' + String.fromCharCode(62);
            const safe = sanitize(xss);
            assert(!safe.includes(String.fromCharCode(60) + 'script'), 'Sanitize escapes script tags', 'Security');

            // Sanitize handles empty
            track('sanitizeEmpty');
            assertEqual(sanitize(''), '', 'Sanitize handles empty string', 'Security');
            assertEqual(sanitize(null), '', 'Sanitize handles null', 'Security');

            // Storage uses namespace
            track('storageNamespace');
            assert(CONFIG.storage.selections.startsWith('nd_'), 'Storage uses nd_ prefix', 'Security');

            renderResults('Security Tests');
        }

        // ========================================
        // RUN ALL TESTS
        // ========================================
        function runAllTests() {
            resetTests();

            // Run unit tests
            runUnitTests();
            const unitResults = { ...tests };

            // Run integration tests
            resetTests();
            runIntegrationTests();
            const integrationResults = { ...tests };

            // Run security tests
            resetTests();
            runSecurityTests();
            const securityResults = { ...tests };

            // Combine results
            tests.passed = unitResults.passed + integrationResults.passed + securityResults.passed;
            tests.failed = unitResults.failed + integrationResults.failed + securityResults.failed;
            tests.total = unitResults.total + integrationResults.total + securityResults.total;
            tests.results = [...unitResults.results, ...integrationResults.results, ...securityResults.results];

            renderResults('All Tests');
            showCoverage();
        }

        // ========================================
        // UI HELPERS
        // ========================================
        function resetTests() {
            tests = { passed: 0, failed: 0, total: 0, results: [] };
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('coverage-section').style.display = 'none';
        }

        function renderResults(suiteName) {
            const resultsDiv = document.getElementById('results');

            // Group by category
            const categories = {};
            tests.results.forEach(t => {
                if (!categories[t.category]) categories[t.category] = [];
                categories[t.category].push(t);
            });

            let html = '';
            Object.entries(categories).forEach(([cat, catTests]) => {
                html += `<div class="test-section"><h2>${cat}</h2>`;
                catTests.forEach(t => {
                    html += `<div class="test-case ${t.status}">${t.name} <span>${t.status === 'pass' ? 'âœ…' : 'âŒ'}</span></div>`;
                });
                html += '</div>';
            });

            const passRate = tests.total > 0 ? ((tests.passed / tests.total) * 100).toFixed(1) : 0;
            const summaryClass = tests.failed === 0 ? 'pass' : 'fail';

            html += `
                <div class="summary ${summaryClass}">
                    <strong>${suiteName}:</strong> ${tests.passed}/${tests.total} passed (${passRate}%)
                    ${tests.failed > 0 ? `<br>âŒ ${tests.failed} failed` : '<br>âœ… All tests passed!'}
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function showCoverage() {
            const section = document.getElementById('coverage-section');
            const details = document.getElementById('coverage-details');

            const functions = [
                'MEAL_DATA', 'MEAL_OPTIONS', 'SNACKS', 'RECIPES', 'TIME_RANGES', 'QUICK_BITES', 'ENV', 'DAILY_ESSENTIALS',
                'uniqueRecipeIds', 'mealDays', 'getStore', 'setStore', 'capitalizeFirst',
                'importData', 'titleDedup', 'mealGrouping', 'filterLogic', 'timeBasedTab', 'ingredientDedup',
                'samplePlanExport', 'modalHidden', 'dateFormatting', 'selectionStorage', 'customMealStructure', 'importedMealStructure',
                'sanitize', 'sanitizeNormal', 'sanitizeXSS', 'sanitizeEmpty', 'storageNamespace', 'CONFIG'
            ];

            const covered = functions.filter(f => coverageTracker.has(f)).length;
            const percentage = ((covered / functions.length) * 100).toFixed(1);

            section.style.display = 'block';
            details.innerHTML = `
                <p><strong>Functions Tested:</strong> ${covered}/${functions.length}</p>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: ${percentage}%"></div>
                </div>
                <p style="margin-top: 8px; font-size: 1.2em;"><strong>${percentage}%</strong> code coverage</p>
                <pre>Covered: ${Array.from(coverageTracker).join(', ')}</pre>
            `;
        }

        // Auto-run on load
        window.onload = () => {
            console.log('ğŸ§ª Test Suite Ready - Click "Run All Tests" to start');
        };
    </script>
</body>

</html>