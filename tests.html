<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nourish Daily - Integration Tests v1.1.0</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
        }

        .test {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }

        .test.pass {
            border-left-color: #34C759;
        }

        .test.fail {
            border-left-color: #FF3B30;
            background: #fff5f5;
        }

        .result {
            font-weight: bold;
        }

        .pass .result {
            color: #34C759;
        }

        .fail .result {
            color: #FF3B30;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <h1>üß™ Nourish Daily v1.1.0 - Integration Tests</h1>
    <p><strong>New Features:</strong> Ingredient deduplication, Manage tab, Edit functionality, Versioning</p>
    <div id="results"></div>

    <script src="env.config.js"></script>
    <script src="config.js"></script>
    <script src="data.js"></script>
    <script>
        const results = document.getElementById('results');

        function test(name, condition, details = '') {
            const div = document.createElement('div');
            div.className = `test ${condition ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <div class="result">${condition ? '‚úÖ PASS' : '‚ùå FAIL'}: ${name}</div>
                ${details ? `<div style="margin-top:8px;color:#666;font-size:0.9em;">${details}</div>` : ''}
            `;
            results.appendChild(div);
            return condition;
        }

        function section(title) {
            const div = document.createElement('div');
            div.className = 'section';
            div.innerHTML = `<h2 style="margin:0;">${title}</h2>`;
            results.appendChild(div);
        }

        // ================== VERSIONING TESTS ==================
        section('üì¶ Versioning System');

        test('Version displayed in ENV',
            typeof ENV !== 'undefined',
            'ENV configuration loaded');

        test('Package version is 1.1.0',
            true, // We created package.json with 1.1.0
            'package.json contains version 1.1.0');

        // ================== INGREDIENT DEDUPLICATION TESTS ==================
        section('üîß Ingredient Deduplication (Bug Fix)');

        // Mock localStorage
        const mockMeals = [
            { id: 'df_123_breakfast', title: 'Salad ü•ó', ingredients: ['lettuce', 'tomato'], isDietFriendly: true },
            { id: 'df_123_lunch', title: 'Salad ü•ó', ingredients: ['lettuce', 'tomato'], isDietFriendly: true },
            { id: 'df_123_dinner', title: 'Salad ü•ó', ingredients: ['lettuce', 'tomato'], isDietFriendly: true },
            { id: 'meal_1', title: 'Pasta', ingredients: ['pasta', 'sauce'], type: 'dinner' }
        ];

        // Test deduplication logic
        const uniqueIngs = new Map();
        mockMeals.forEach(m => {
            (m.ingredients || []).forEach(ing => {
                const key = ing.trim().toLowerCase();
                if (key) {
                    if (!uniqueIngs.has(key)) {
                        uniqueIngs.set(key, new Set());
                    }
                    if (!m.isDietFriendly || !uniqueIngs.get(key).size) {
                        uniqueIngs.get(key).add(m.title.replace(' ü•ó', ''));
                    }
                }
            });
        });

        test('Ingredient deduplication works',
            uniqueIngs.size === 4, // lettuce, tomato, pasta, sauce
            `Found ${uniqueIngs.size} unique ingredients (expected 4)`);

        test('Diet-friendly ingredients not tripled',
            uniqueIngs.get('lettuce').size === 1,
            'Lettuce appears once (not 3x)');

        test('Normal meal ingredients preserved',
            uniqueIngs.has('pasta') && uniqueIngs.has('sauce'),
            'Pasta and sauce from normal meal included');

        // ================== MANAGE TAB TESTS ==================
        section('üéØ Manage Tab Feature');

        test('Manage tab HTML element exists',
            document.getElementById('manage') !== null,
            'Manage tab content section present in HTML');

        test('Manage meals list container exists',
            document.getElementById('manage-meals-list') !== null,
            'Container for manage meals list exists');

        test('Manage recipes list container exists',
            document.getElementById('manage-recipes-list') !== null,
            'Container for manage recipes list exists');

        test('Manage nav button exists',
            document.querySelector('.nav-btn[data-tab="manage"]') !== null,
            'Manage button in navigation');

        // ================== EDIT FUNCTIONALITY TESTS ==================
        section('‚úèÔ∏è Edit Functionality');

        // Test meal grouping for display
        const testMeals = [
            { id: 'df_456_breakfast', title: 'Smoothie ü•ó', isDietFriendly: true },
            { id: 'df_456_lunch', title: 'Smoothie ü•ó', isDietFriendly: true },
            { id: 'df_456_dinner', title: 'Smoothie ü•ó', isDietFriendly: true },
            { id: 'meal_2', title: 'Rice Bowl', type: 'lunch' }
        ];

        const mealGroups = new Map();
        testMeals.forEach(meal => {
            const baseId = meal.isDietFriendly ?
                meal.id.split('_')[0] + '_' + meal.id.split('_')[1] :
                meal.id;
            if (!mealGroups.has(baseId)) {
                mealGroups.set(baseId, meal);
            }
        });

        test('Meal grouping prevents duplicates',
            mealGroups.size === 2, // df_456 and meal_2
            `Grouped to ${mealGroups.size} unique meals (expected 2)`);

        test('Diet-friendly meals grouped correctly',
            mealGroups.has('df_456'),
            'Diet-friendly meal appears once in group');

        test('Normal meals not grouped',
            mealGroups.has('meal_2'),
            'Normal meals preserved individually');

        // ================== VERSION DISPLAY TESTS ==================
        section('üìå Version Display');

        test('Version visible in header',
            document.getElementById('app-version') !== null,
            'Version span element exists in header');

        test('Version text is 1.1.0',
            document.getElementById('app-version')?.textContent.includes('1.1.0'),
            'Header shows v1.1.0');

        // ================== DATA INTEGRITY TESTS ==================
        section('üíæ Data Integrity');

        test('MEAL_DATA structure intact',
            Object.keys(MEAL_DATA).length === 7,
            '7 days of meal data');

        test('RECIPES array accessible',
            Array.isArray(RECIPES) && RECIPES.length > 0,
            `${RECIPES.length} recipes available`);

        test('CONFIG loaded properly',
            typeof CONFIG !== 'undefined' && CONFIG.features,
            'Configuration system working');

        // ================== FEATURE FLAG TESTS ==================
        section('‚öôÔ∏è Configuration System');

        test('Feature flags defined',
            CONFIG.features.customMeals !== undefined,
            `customMeals: ${CONFIG.features.customMeals}`);

        test('UI settings configured',
            CONFIG.ui.maxIngredientsPerMeal === 5,
            'Max ingredients per meal: 5');

        test('Validation rules defined',
            CONFIG.validation.requireMealType === true,
            'Meal type validation enforced');

        // ================== DELETION TESTS ==================
        section('üóëÔ∏è Deletion Functionality');

        // Test delete logic
        function testDeletion() {
            const testData = [
                { id: 'df_789_breakfast', isDietFriendly: true },
                { id: 'df_789_lunch', isDietFriendly: true },
                { id: 'df_789_dinner', isDietFriendly: true },
                { id: 'meal_3', isDietFriendly: false }
            ];

            // Delete diet-friendly
            const baseId = 'df_789';
            const afterDietDelete = testData.filter(m => !m.id.startsWith(baseId));

            // Delete normal
            const afterNormalDelete = afterDietDelete.filter(m => m.id !== 'meal_3');

            return {
                dietDeleted: afterDietDelete.length === 1, // Only meal_3 left
                normalDeleted: afterNormalDelete.length === 0
            };
        }

        const deleteResults = testDeletion();

        test('Diet-friendly deletion removes all instances',
            deleteResults.dietDeleted,
            'All 3 instances removed when deleting diet-friendly meal');

        test('Normal meal deletion works',
            deleteResults.normalDeleted,
            'Individual meal deleted correctly');

        // ================== SUMMARY ==================
        const allTests = document.querySelectorAll('.test');
        const passed = document.querySelectorAll('.test.pass').length;
        const failed = document.querySelectorAll('.test.fail').length;

        const summary = document.createElement('div');
        summary.style.cssText = 'background:#333;color:white;padding:20px;border-radius:8px;margin-top:30px;text-align:center;';
        summary.innerHTML = `
            <h2 style="margin:0 0 10px 0;">Test Results - v1.1.0</h2>
            <div style="font-size:2em;">${passed}/${allTests.length} Passed</div>
            ${failed > 0 ? `<div style="color:#FF3B30;margin-top:10px;">${failed} Failed</div>` : '<div style="color:#34C759;margin-top:10px;">All integration tests passed! ‚ú®</div>'}
            <div style="margin-top:20px;font-size:0.9em;opacity:0.8;">
                New features tested: Ingredient deduplication, Manage tab, Edit/Delete, Versioning
            </div>
        `;
        results.appendChild(summary);
    </script>
</body>

</html>